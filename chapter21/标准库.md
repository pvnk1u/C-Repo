# 标准库

前面几章中零散的学习了一些C语言标准库的相关知识。在本章中，将完整地讨论标准库。第一节列举使用库的一些通用的指导原则，并介绍了会在一些库的头中发现的技巧：使用宏来“隐藏函数”。21.2节会对C89库的每个头分别做概述性介绍，21.3节会对C99库的新头做概述性介绍。



在随后几章中，将深入讨论标准库的头，并将相关联的头放在一起讨论。其中`<stddef.h>`和`<stdbool.h>`非常简短，所以在本章加以讨论。



## 标准库的使用

C89标准库总共划分成15个部分，每个部分用一个头描述。C99新增了9个头，总共有24个。见下表：

| <assert.h>       | <inttypes.h>(C99) | <signal.h>       | <stdlib.h>      |
| ---------------- | ----------------- | ---------------- | --------------- |
| <complex.h>(C99) | <iso646.h>(C99)   | <stdarg.h>       | <string.h>      |
| <ctype.h>        | <limits.h>        | <stdbool.h>(C99) | <tgmath.h>(C99) |
| <errno.h>        | <locale.h>        | <stddef.h>       | <time.h>        |
| <fenv.h>(C99)    | <math.h>          | <stdint.h>(C99)  | <wchar.h>(C99)  |
| <float.h>        | <setjmp.h>        | <stdio.h>        | <wctype.h>(C99) |

大多数编译器都会使用更大的库，但是它们不属于标准库的范畴，所以不能假设其他编译器也支持这些头。



标准头主要由函数原型、类型定义以及宏定义组成。如果我们的文件中调用了头中声明的函数，或是使用了头中定义的类型或宏，就需要在文件开头将相应的头包含进来。当一个文件包含多个标准头时，`#include`指令的顺序无关紧要。多次包含同一个标准头也是合法的。



### 对标准库值所用名字的限制

**任何包含了标准头的文件都必须遵守两条规则。第一，该文件不能将头🀄️定义过的宏的名字用于其他目的。例如，如果某个文件包含了`<stdio.h>`，就不能重新定义NULL了，因为使用这个名字的宏已经在`<stdio.h>`中定义过了。第二，具有文件作用域的库名（尤其是typedef名）也不可以在文件层次重定义。因此，一旦文件包含了`<stdio.h>`，由于`<stdio.h>`中已经将size_t定义为typedef名，那么在文件作用域内都不能将size_t重定义为任何标识符。**



上述这些限制是显而易见的，但C语言还有一些其他的限制，可能是想不到的。

- **由一个下划线和一个大写字母开头或由两个下划线开头的标识符是为标准库保留的标识符。程序不允许为任何目的使用这种形式的标识符。**
- **由一个下划线开头的标识符被保留用作具有文件作用域的标识符和标记。除非在函数内部声明，否则不应该使用这类标识符。**
- **在标准库中所有具有外部链接的标识符被保留用作具有外部链接的标识符。特别是所有标准库函数的名字都被保留。因此，即使文件没有包含`<stdio.h>`，也不应该定义名为printf的外部函数，因为在标准库中已经有一个同名的函数了。**

这些规则对程序的所有文件都起作用，不论文件包含了哪个头。虽然这些规则并不总是强制性的，但不遵守这些规则可能会导致程序不具有可移植性。



### 使用宏隐藏的函数

C程序员经常会使用带参数的宏来替代小的函数，这在标准库中同样很常见。C标准允许在头中定义与库函数同名的宏，为了起到保护作用，还要求有实际的函数存在。因此，对于库的头，声明一个函数并同时定义一个有相同名字的宏的函数并不少见。



之前已经见过宏与库函数同名的例子。getchar是声明在`<stdio.h>`中的库函数，它具有如下原型：

```c
int getchar(void);
```

`<stdio.h>`通常也把getchar定义为一个宏：

```c
#define getchar() getc(stdin)
```

在默认情况下，对getchar的调用会被看作宏调用（因为宏名会在预处理时被替换）。



在大多数情况下，我们喜欢使用宏来替代实际的函数，因为这样可能会提高程序的运行速度。然而在某些情况下，我们可能需要的是一个真实的函数，可能是为了尽量缩小可执行代码的大小。



如果确实存在这种需求，可以使用`#undef`指令来删除宏定义。例如，我们可以在包含了`<stdio.h>`后删除宏getchar的定义：

```c
#include <stdio.h>
#undef getchar
```

即使getchar不是宏，这样的做法也不会带来任何坏处，因为当给定的名字没有被定义成宏时，#undef指令不会起任何作用。



## C89标准库概述

简单概述下C89标准库中的头。后续会对每个头做更详细的介绍。

1. <assert.h>：诊断

   <assert.h>头仅baohanassert宏，它允许我们在程序中插入自我检查。一旦任何检查失败，程序会被终止。

2. <ctype.h>：字符处理

   <ctype.h>头提供用于字符分类及大小写转换的函数。

3. <errno.h>：错误

   <errno.h>头提供了errno（error number）。errno是一个左值，可以在调用特定库函数后进行检测，来判断调用过程中是否有错误发生。

4. <float.h>：浮点类型的特性

   <float.h>头提供了用于描述浮点类型特性的宏，包括值的范围及精度。

5. <limits.h>：整数类型的大小

   <limits.h>提供了用于描述整型类型（包括字符类型）特性的宏，包括它们的最大值和最小值。

6. <locale.h>：本地化

   <locale.h>头提供一些函数来帮助程序适应针对某个国家或地区的特定行为方式。这些与本地化相关的行为包括显示数的方式（如用作小数点的字符）、货币的格式（如货币符号）、字符集以及日期和时间的表示形式。

7. <math.h>：数学计算

   <math.h>头提供了常见的数学函数，包括三角函数、双曲函数、指数函数、对数函数、幂函数、邻近取整函数、绝对值运算函数以及取余函数。

8. <setjmp.h>：非本地跳转

   <setjmp.h>头提供了setjmp函数和longjmp函数。setjmp函数会“标记”程序中的一个位置，随后可以用longjmp返回被标记的位置。这些函数可以用来从一个函数跳转到另一个（仍在活动中的）函数中，而绕过正常的函数返回机制。setjmp函数和longjmp函数主要用来处理程序执行过程中出现的严重问题。

9. <signal.h>：信号处理

   <signal.h>头提供了用于处理异常情况（信号）的函数，包括中断和运行时错误。signal函数可以设置一个函数，使系统会在给定信号发生后自动调用该函数：raise函数用来产生信号。

10. <stdarg.h>：可变参数

    <stdarg.h>头提供了一些工具用于编写参数个数可变的函数，就像printf和scanf函数一样。

11. <stddef.h>：常用定义

    <stddef.h>头提供了经常使用的类型和宏的定义。

12. <stdio.h>：输入/输出

    <stdio.h>头提供了大量的输入/输出函数，包括对顺序访问和随机访问文件的操作。

13. <stdlib.h>：常用实用程序

    <stdlib.h>头包含了大量无法划归其他头的函数。包含在<stdlib.h>中的函数可以将字符串转换成数，产生伪随机数，执行内存管理任务，与操作系统通信，执行搜索与排序，以及在多字节字符与宽字符之间进行转换。

14. <string.h>：字符串处理

    <string.h>头提供了用于进行字符串操作（包括复制、拼接、比较及搜索）的函数以及对任意内存块进行操作的函数。

15. <time.h>：日期和时间

    <time.h>提供相应的函数来获取时间（和日期），操纵时间，以及格式化时间的显示。



## C99标准库更新

C99对标准库的改变主要分为以下三个类：

- 新增头

  在C99标准库中有9个头是C89中没有的。事实上其中三个（<iso646.h>、<wchar.h>和<wctype.h>）在1995年修订C89时就增加到了C中，另外6个（<complex.h>、<fenv.h>、<inttypes.h>、<stdbool.h>、<stdint.h>和<tgmath.h>）是C99新增的。

- 新增宏和函数

  C99标准在一些已有的头中增加了宏和函数，这些头主要有<float.h>、<math.h>和<stdio.h>。在<math.h>头中增加了非常多的内容，后面会专门讲述。

- 对已有函数的改进

  一些已存在的函数（包括printf和scanf）在C99中具有了更多的功能。



接下来快速浏览一下C99标准库中新增的9个头：

1. <complex.h>：复数算术

   <complex.h>头定义了complex和I宏，这两个宏对于复数运算来说非常有用。该头还提供了对复数进行数学运算的函数。

2. <fenv.h>：浮点环境

   <fenv.h>头提供了对浮点状态标志和控制模式的访问。例如，程序可以测试标志来判断浮点数运算过程中是否发生了溢出，或者设置控制模式来指定如何进行取整。

3. <inttypes.h>：整数类型格式转换

   <inttypes.h>头定义了可用于<stdint.h>中声明的整数类型的输入/输出的格式化字符串的宏，还提供了处理最大宽度整数的函数。

4. <iso646.h>：拼写转换

   <iso646.h>头定义了可代表特定运算符的宏。可用于编程环境的本地字符集没有这些字符时。

5. <stdbool.h>：布尔类型和值

   <stdbool.h>头定义了bool、true和false宏，同时还定义了一个可用于测试这些宏是否已被定义的宏。

6. <stdint.h>：整数类型

   <stdint.h>头声明了指定宽度的整数类型并定义了相关的宏（例如指定每种类型的最大和最小值的宏）。同时定义了用于构建具体类型的整数常量的带参数的宏。

7. <tgmath.h>：泛型数学

   在C99中，<math.h>和<complex.h>头中的许多数学函数都有多个版本。<tgmath.h>头中的泛型宏可以检测传递给它们的参数的类型，并替代为相应<math.h>或<complex.h>中函数的调用。

8. <wchar.h>：扩展的多字节和宽字符实用工具

   <wchr.h>头提供了宽字符输入/输出和宽字符串操作的函数。

9. <wctyp.h>：宽字符分类和映射实用工具

   <wctype.h>头是<ctype.h>的宽字符版本，提供了对宽字符进行分类和修改的函数。



## <stddef.h>：常用定义

