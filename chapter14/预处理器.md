# 预处理器

之前用到过`#define`与`#include`指令，但没有深入讨论。这些指令（以及还没有学到的指令）都是由预处理器处理的。预处理器是一个小软件，它可以在编译前处理C程序。C语言（和C++语言）因为依赖预处理器而不同于其他的编程语言。



预处理器是一种强大的工具，但它同时也可能是许多难以发现的错误的根源。此外，预处理器也可能被错误地用来编写出一些几乎不可能读懂的程序。尽管有些C程序员十分依赖于预处理器，但是依然建议适度地使用它。



## 预处理器的工作原理

预处理器的行为是由预处理指令（由#字符开头的一些命令）控制的。之前已经遇见过其中两种指令，即`#define`和`#include`。



`#define`指令定义了一个宏——用来代表其他东西的一个名字，例如常量或常用的表达式。预处理器会通过将宏的名字和它的定义存储在一起来响应`#define`指令。当这个宏在后面的程序中使用到时，预处理器”扩展“宏，将宏替换为其定义值。



`#define`指令告诉预处理器打开一个特定的文件，将它的内容作为正在编译的文件的一部分”包含“进来。例如，代码行

```c
#include <stdio.h>
```

指示预处理器打开一个名字为`stdio.h`的文件，并将它的内容加到当前的程序中。（`stdio.h`包含了C语言标准输入/输出函数的原型。）



以下是预处理器在编译过程中的作用：

> C程序中可能包含指令。预处理器会执行这些指令，并在处理过程中删除这些指令。预处理器的输出是另一个C程序：原程序编辑后的版本，不再包含指令。预处理器的输出被直接交给编译器，编译器检查程序是否有错误，并将程序翻译为目标代码（机器指令）。



为了展现预处理器的作用，以之前的`celsius.c`为例，下面是源程序：

```c

#include <stdio.h>

#define FREEZING_PT 32.0f
#define SCALE_FACTOR (5.0f / 9.0f)

int main(void) {
    float fahrenheit,celsius;

    printf("Enter Fahrenheit temperature: ");
    scanf("%f",&fahrenheit);

    celsius = (fahrenheit - FREEZING_PT) * SCALE_FACTOR;

    printf("Celsius equivalent: %.1f\n",celsius);
    return 0;
}
```

预处理结束后，程序是下面的样子：

```c
空行
空行
从stdio.h中引入的行
空行
空行
空行
空行
int main(void){
	 float fahrenheit,celsius;

    printf("Enter Fahrenheit temperature: ");
    scanf("%f",&fahrenheit);

    celsius = (fahrenheit - 32.0f) * (5.0f/9.0f);

    printf("Celsius equivalent: %.1f\n",celsius);
    return 0;
}
```

预处理器通过引入`stdio.h`的内容来响应`#define`指令。预处理器也删除了`#define`指令，并且替换了该文件中稍后出现在任何位置上的`FREEZING_PT`和`SCALE_FACTOR`。请注意预处理器并没有删除包含指令的行，而是简单地将它们替换为空。



## 预处理指令

大多数预处理指令都属于下面3种类型之一。

- 宏定义

  `#define`指令定义一个宏，`#undef`指令删除一个宏定义。

- 文件包含

  `#include`指令导致一个指定文件的内容被包含到程序中

- 条件编译

  `#if`、`#ifdef`、`#ifndef`、`#elif`、`else`和`#endif`指令可以根据预处理器可以测试的条件来确定是将一段文本块包含到程序中还是将其排除在程序之外。



剩下的`#error`、`#line`和`#pragma`指令是更特殊的指令，较少用到。



在进一步讨论之前，先来看几条适用于所有指令的规则。

- 指令都以`#`开始

  `#`符号不需要在一行的行首，只要它之前只有空白字符就行。在`#`后是指令名，接着是指令所需要的其他信息。

- 在指令的符号之间可以插入任意数量的空格或水平制表符。例如，下面的指令是合法的：

  ```c
  #	define	N	100
  ```

- 指令总在第一个换行符处结束，除非明确地指明要延续。如果想在下一行延续指令，必须在当前行的末尾使用`\`字符。例如，下面的指令定义了一个宏来表示硬盘的容量，按字节计算：

  ```C
  #define DISK_CAPACITY(SIDES *	\
  						TRACKS_PER_SIDE *	\
  						SECTORS_PER_TRACK	*	\
  						BYTE_PER_SECTOR)
  ```

- 指令可以出现在程序的任何地方。但我们通常将`#define`和`#include`指令放在文件的开始，其他指令则放在后面，甚至可以放在函数定义的中间。

- 注释可以与指令放在同一行。实际上，在宏定义的后面加一个注释来解释宏的定义是一种比较好的习惯：

  ```c
  #define FREEZING_PT 32.0f	// freezing point of water
  ```



## 宏定义

