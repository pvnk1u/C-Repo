# 输入/输出

C语言的输入/输出库是标准库中最大且最重要的部分。由于输入/输出是C语言的高级应用，因此将用一整章来讨论`<stdio.h>`头——输入/输出函数存放的主要地方。



从第二章开始已经在使用`<stdio.h>`了，而且已经对printf函数、scanf函数、putchar函数、getchar函数、puts函数以及gets函数的使用有了一定的了解。本章会涉及更多有关这6个函数的信息，并介绍一些新的用于文件处理的函数。值得高兴的是，许多新函数和已经熟知的函数有着紧密的关系。例如，fprintf函数就是printf函数的“文件版”。



本章的开始会讨论一些基本问题：流的概念、FILE类型、输入和输出重定向以及文本文件和二进制文件的差异（22.1节）。随后将转入讨论特别为使用文件而设计的函数，包括打开和关闭文件的函数（22.2节）。在讨论完printf函数、scanf函数以及与“格式化”输入/输出相关的函数（22.3节）以后，将着眼于读/写非格式化数据的函数。

- 每次读写一个字符的getc函数、putc函数以及相关的函数（22.4节）
- 每次读写一行字符的gets函数、puts函数以及相关的函数（22.5节）
- 读/写数据块的fread函数和fwrite函数（22.6节）



随后，22.7节会说明如何对文件上执行随机的访问操作。最后，22.8节会描述sprintf函数、snprintf函数和sscanf函数，它们是printf函数和scanf函数的变体，后两者分别用于写入和读取一个字符串。



本章涵盖了`<stdio.h>`中的绝大部分函数，但忽略了其中8个函数。perror函数是这8个函数中的一个，它与`<errno.h>`紧密相关，所以推迟到24.2节讨论`<errno.h>`头时进行介绍。26.1节涵盖了其中7个函数（vfprintf、vprintf、vsprintf、vsnprintf、vfscanf、vscanf和vsscanf）。这些函数依赖于va_list类型，该类型在26.1节介绍。



在C89中，所有的标准输入/输出函数都属于`<stdio.h>`。但C99有所不同，有些输入/输出函数在`<wchar.h>`头（25.5节）中声明。`<wchar.h>`中的函数用于处理宽字符而不是普通字符，但大多数函数与`<stdio.h>`中的函数紧密相关。`<stdio.h>`中用于读或写数据的函数称为字节输入/输出函数，而`<wchar.h>`中的类似函数则称为宽字符输入/输出函数。



## 流

在C语言中，术语流（stream）表示任意输入的源或任意输出的目的地。许多小型程序（就像前面章节中的那些）都是通过一个流（通常和键盘相关）获得全部的输入，并且通过另一个流（通常和屏幕相关）写出全部的输出。



较大规模的程序可能会需要额外的流。这些流常常表示存储在不同介质（如硬盘驱动器、CD、DVD和闪存）上的文件，但也很容易和不存储文件的设备（网络端口、打印机等）相关联。这里将集中讨论文件因为它们常见且容易理解（在应该说流的时候，有时会使用术语文件）。但是一定要记住，`<stdio.h>`中的许多函数可以处理各种形式的流，而不仅仅可以处理表示文件的流。



### 文件指针

C程序中对流的访问时通过**文件指针（file pointer）**实现的。此指针的类型为`FILE *`（FILE类型在`<stdio.h>`中声明）。用文件指针表示的特定流具有标准的名字；如果需要，还可以声明另外一些文件指针。例如，如果程序除了标准流之外还需要两个流，则可以包含如下声明：

```c
FILE *fp1,*fp2;
```

虽然操作系统通常会限制可以同时打开的流的数量，但程序可以声明任意数量的`FILE *`类型变量。



### 标准流和重定向

`<stdio.h>`提供了3个标准流（如下表）。这3个标准流可以直接使用——不需要对其进行声明，也不用打开或关闭它们。

| 文件指针 | 流       | 默认的含义 |
| -------- | -------- | ---------- |
| stdin    | 标准输入 | 键盘       |
| stdout   | 标准输出 | 屏幕       |
| stderr   | 标准错误 | 屏幕       |

前面章节使用过的函数（printf、scanf、putchar、getchar、puts和gets）都是通过stdin获得输入，并且用stdout进行输出的。默认情况下，stdin表示键盘，而stdout和stderr则表示屏幕。然而，许多操作系统允许通过一种称为**重定向（redirection）**的机制来改变这些默认的定义。



通常，我们可以强制程序从文件而不是从键盘获得输入，方法是在命令行这放上文件的名字，并在前面加上字符`<`：

```c
demo <in.dat
```

这种方法称为输入**重定向（input direction）**，它本质上是使stdin流表示文件（此例中为文件in.dat）而非键盘。重定向的绝妙之处在于，demo程序不会意识到正在从文件**in.dat**中读取数据，它会认为从stdin获得的任何数据都是从键盘上录入的。



**输出重定向（output redirection）**也是类似的。对stdout流的重定向通常是通过在命令行中放置文件名，并在前面加上字符`>`实现的：

```shell
demo >out.dat
```

现在所有写入stdout的数据都将进入`out.dat`文件中，而不是出现在屏幕上了。顺便说一下，还可以把输出重定向和输入重定向结合使用：

```shell
demo <in.dat >out.dat
```

字符`<`和`>`不需要与文件名相邻，重定向文件的顺序也是无关紧要的，所以下面的例子效果一样：

```shell
demo < in.dat > out.dat
demo >out.dat <in.dat
```

输出重定向的一个问题是会把写入stdout的所有内容都放入到文件中。如果程序运行失常并且开始写出错消息，那么我们只能在看文件的时候才会知道。而这些应该是出现在stderr中的。通过把出错消息写到stderr而不是stdout中，我们可以保证即使在对stdout进行重定向时这些出错消息仍能出现在屏幕上。（不过，操作系统通常也允许对stderr进行重定向。）



### 文本文件与二进制文件

`<stdio.h>`支持两种类型的文件：文本文件和二进制文件。在**文本文件（text file）**中，字节表示字符，这使人们可以检查或编辑文件。例如，C程序的源代码时存储在文本文件中的。另一方面，在**二进制文件（binary file）**中，字节不一定表示字符；字节组还可以表示其他类型的数据，比如整数和浮点数。如果试图查看可执行C程序的内容，会立刻意识到它时存储在二进制文件中的。